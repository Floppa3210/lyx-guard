--[[
    LyxGuard v4.1 - Weapon Exploit Detection Module

    Concept Source: SecureServe
    Rewritten from scratch with LyxGuard architecture

    Features:
    - Damage modifier detection
    - No reload / infinite ammo detection
    - Blacklisted weapon detection
]]

-- ═══════════════════════════════════════════════════════════════════════════════
-- 1. WEAPON DAMAGE MODIFIER DETECTION
-- Detects weapons with modified damage values
-- ═══════════════════════════════════════════════════════════════════════════════

local DamageModState = {
    suspiciousCount = 0
}

RegisterDetection('damage_modifier', {
    enabled = true,
    punishment = 'ban_temp',
    banDuration = 'long',
    tolerance = 3,
    maxDamageMultiplier = 1.5,
    checkInterval = 2000
}, function(config, state)
    -- Skip if immune
    if Helpers and Helpers.IsPlayerImmune and Helpers.IsPlayerImmune() then return false end

    local playerPed = PlayerPedId()
    local _, currentWeapon = GetCurrentPedWeapon(playerPed, true)

    -- Skip unarmed
    if not currentWeapon or currentWeapon == GetHashKey('WEAPON_UNARMED') then
        return false
    end

    -- Check damage modifier using native
    -- 0x4757f00bc6323cfe = GET_WEAPON_DAMAGE_MODIFIER
    local damageModifier = Citizen.InvokeNative(0x4757f00bc6323cfe, currentWeapon, 1.0)

    if damageModifier > config.maxDamageMultiplier then
        DamageModState.suspiciousCount = DamageModState.suspiciousCount + 1

        if DamageModState.suspiciousCount >= config.tolerance then
            DamageModState.suspiciousCount = 0

            -- Try to reset the damage
            pcall(function()
                Citizen.InvokeNative(0x4757f00bc6323cfe, currentWeapon, 1.0)
            end)

            return true, {
                weapon = currentWeapon,
                damageModifier = damageModifier
            }
        end
    else
        DamageModState.suspiciousCount = math.max(0, DamageModState.suspiciousCount - 1)
    end

    return false
end, 'periodic')

-- ═══════════════════════════════════════════════════════════════════════════════
-- 2. NO RELOAD / INFINITE AMMO DETECTION
-- Detects weapons that never need to reload
-- ═══════════════════════════════════════════════════════════════════════════════

local NoReloadState = {
    lastAmmo = nil,
    lastWeapon = nil,
    sameAmmoCount = 0
}

RegisterDetection('infinite_ammo', {
    enabled = true,
    punishment = 'ban_temp',
    banDuration = 'medium',
    tolerance = 7,
    checkInterval = 50
}, function(config, state)
    -- Skip if immune
    if Helpers and Helpers.IsPlayerImmune and Helpers.IsPlayerImmune() then return false end

    local playerPed = PlayerPedId()
    local _, currentWeapon = GetCurrentPedWeapon(playerPed, true)

    -- Skip unarmed
    if not currentWeapon or currentWeapon == GetHashKey('WEAPON_UNARMED') then
        NoReloadState.lastAmmo = nil
        NoReloadState.sameAmmoCount = 0
        return false
    end

    -- Skip melee weapons
    local weaponGroup = GetWeapontypeGroup(currentWeapon)
    if weaponGroup == GetHashKey('WEAPON_GROUP_MELEE') then
        return false
    end

    -- Only check while shooting
    if not IsPedShooting(playerPed) then
        return false
    end

    -- Check if weapon is ready
    if not IsPedWeaponReadyToShoot(playerPed) then
        return false
    end

    local currentAmmo = GetAmmoInPedWeapon(playerPed, currentWeapon)

    -- Changed weapon, reset
    if currentWeapon ~= NoReloadState.lastWeapon then
        NoReloadState.lastAmmo = currentAmmo
        NoReloadState.lastWeapon = currentWeapon
        NoReloadState.sameAmmoCount = 0
        return false
    end

    -- Shooting but ammo didn't decrease
    if NoReloadState.lastAmmo and currentAmmo >= NoReloadState.lastAmmo then
        NoReloadState.sameAmmoCount = NoReloadState.sameAmmoCount + 1

        if NoReloadState.sameAmmoCount >= config.tolerance then
            NoReloadState.sameAmmoCount = 0
            return true, {
                weapon = currentWeapon,
                ammo = currentAmmo
            }
        end
    else
        -- Ammo decreased normally
        NoReloadState.sameAmmoCount = 0
    end

    NoReloadState.lastAmmo = currentAmmo

    return false
end, 'fast')

-- ═══════════════════════════════════════════════════════════════════════════════
-- 3. BLACKLISTED WEAPON DETECTION
-- Detects weapons that shouldn't be available
-- ═══════════════════════════════════════════════════════════════════════════════

local BlacklistedWeapons = {
    'WEAPON_RAILGUN',
    'WEAPON_MINIGUN',
    'WEAPON_RPG',
    'WEAPON_GRENADELAUNCHER',
    'WEAPON_HOMINGLAUNCHER',
    'WEAPON_STICKYBOMB',
    'WEAPON_PROXMINE',
    'WEAPON_PIPEBOMB',
    'WEAPON_RAYPISTOL',
    'WEAPON_RAYCARBINE',
    'WEAPON_RAYMINIGUN',
    'WEAPON_EMPLAUNCHER',
    'WEAPON_HEAVYSNIPER_MK2',
    'WEAPON_MARKSMANRIFLE_MK2'
}

local BlacklistHashes = {}
for _, weapon in ipairs(BlacklistedWeapons) do
    BlacklistHashes[GetHashKey(weapon)] = true
end

RegisterDetection('blacklisted_weapon', {
    enabled = true,
    punishment = 'ban_temp',
    banDuration = 'long',
    tolerance = 1,
    checkInterval = 2000
}, function(config, state)
    -- Skip if immune
    if Helpers and Helpers.IsPlayerImmune and Helpers.IsPlayerImmune() then return false end

    local playerPed = PlayerPedId()
    local _, currentWeapon = GetCurrentPedWeapon(playerPed, true)

    if currentWeapon and BlacklistHashes[currentWeapon] then
        -- Remove the weapon
        RemoveWeaponFromPed(playerPed, currentWeapon)

        return true, {
            weapon = currentWeapon
        }
    end

    return false
end, 'periodic')

print('^2[LyxGuard]^7 Weapon exploit detection module loaded (damage modifier, infinite ammo, blacklisted)')
